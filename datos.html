<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Bar</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="CSS/estilos.css">
    <link rel="stylesheet" href="CSS/responsive.css">
    <link rel="stylesheet" href="CSS/tipografias.css">
    <link rel="stylesheet" href="CSS/login.css">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  
</head>
<body>
<div class="bodyDatos">
  <div class="header">
          <h1>The Vintage Tavern</h1>
        </div>

        <nav class="navbar navbar-expand-sm">
            <div class="container-fluid d-flex justify-content-between">
                <ul class="navbar-nav w-100 d-flex justify-content-between">
                    <li class="nav-item flex-grow-1 dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbardrop" data-toggle="dropdown">
                            Cuenta
                        </a>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="registrarse.html">Registrarse</a>
                            <a class="dropdown-item" href="iniciarSesion.html">Iniciar Sesión</a>
                            <a class="dropdown-item" href="contacto.html">Contacta con nosotros</a>
                        </div>
                    </li>
                    <li class="nav-item flex-grow-1">
                        <a class="nav-link" href="index.html#drunked-container-max">Bar</a>
                    </li>
                    <li class="nav-item flex-grow-1">
                      <a class="nav-link" href="datos.html">Datos</a>
                  </li>
                    <li class="nav-item flex-grow-1">
                        <a class="nav-link" href="index.html#cartas">Cartas</a>
                    </li>
                    <li class="nav-item flex-grow-1">
                        <a class="nav-link" href="index.html#musica-nave">Música</a>
                    </li>
                    <li class="nav-item flex-grow-1">
                        <a class="nav-link" href="index.html#contacto">Contacto</a>
                    </li>
                </ul>
            </div>
        </nav>

      <div>
        <label for="drink-selector">Seleccione una bebida: </label>
        <select id="drink-selector">
          <option value="beer">Cerveza</option>
          <option value="spirit">Licores</option>
          <option value="wine">Vino</option>
        </select>
      </div>
      <div class="legend">
        <h3>Leyenda</h3>
        <div id="legend-content">
          <!-- Leyenda dinámica que se actualizará -->
        </div>
      </div>

      <svg id="map-svg"></svg>
      <div class="tooltip"></div>
  </div>
    <script>
      let svg = d3.select("#map-svg");
      let tooltip = d3.select(".tooltip");

      // Función para recalcular el tamaño del SVG
      function updateMapSize() {
        let width = window.innerWidth;
        let height = window.innerHeight;
        
        svg.attr("width", width)
          .attr("height", height);

        updateMap(currentDrink); // Redibujar el mapa con el tamaño actualizado
      }

      let projection = d3.geoMercator();
      let path = d3.geoPath().projection(projection);

      let currentDrink = "beer"; // Bebida seleccionada

      // Ampliamos la lista de países grandes y relevantes
      let bigCountries = [
        "Russia", "Canada", "China", "United States of America", "Brazil", "Australia", "India", "Argentina", "Kazakhstan", "Greenland",
        "Mexico", "South Africa", "Egypt", "France", "Germany", "Italy", "Japan", "United Kingdom", "Spain", "Saudi Arabia", "Nigeria", 
        "Indonesia", "Turkey", "South Korea", "Colombia", "Thailand", "Vietnam", "Poland", "Ukraine", "Romania", "Chile"
      ];

      d3.csv("./CSV/drinks.csv").then(function(data) {
        let alcoholData = {};
        data.forEach(d => {
          alcoholData[d.country] = {
            beer: +d.beer_servings,
            spirit: +d.spirit_servings,
            wine: +d.wine_servings,
            total_alcohol: +d.total_litres_of_pure_alcohol
          };
        });

        d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson").then(function(world) {
          let countriesWithData = world.features.filter(d => alcoholData[d.properties.name]);

          // Paletas de colores para cada bebida
          let colorPalettes = {
            beer: d3.interpolateYlOrRd,  // Amarillo a rojo para cerveza
            spirit: d3.interpolateBlues, // Azul para licores
            wine: d3.interpolatePurples   // Púrpura para vino
          };

          // Función para actualizar la leyenda
          function updateLegend(selectedDrink) {
            let legendContent = d3.select("#legend-content");
            let colors = colorPalettes[selectedDrink];

            let colorScale = d3.scaleSequential()
              .domain([0, 1])
              .interpolator(colors);

            // Limpiar contenido previo
            legendContent.html("");

            // Añadir colores de la leyenda
            legendContent.append("div")
              .attr("class", "legend-item")
              .html(`<div class="legend-color" style="background-color:${colorScale(0)};"></div> Bajo consumo`);
            legendContent.append("div")
              .attr("class", "legend-item")
              .html(`<div class="legend-color" style="background-color:${colorScale(0.5)};"></div> Medio consumo`);
            legendContent.append("div")
              .attr("class", "legend-item")
              .html(`<div class="legend-color" style="background-color:${colorScale(1)};"></div> Alto consumo`);
          }

          function updateMap(selectedDrink) {
            let width = svg.node().getBoundingClientRect().width;
            let height = svg.node().getBoundingClientRect().height;

            projection.scale(150).translate([width / 2, height / 1.5]);

            let maxVal = d3.max(countriesWithData, d => alcoholData[d.properties.name][selectedDrink]);
            let interpolator = colorPalettes[selectedDrink];
            let colorScale = d3.scaleSequential()
              .domain([0, maxVal])
              .interpolator(t => interpolator(t + 0.2));

            svg.selectAll(".country").remove();
            svg.selectAll(".country-label").remove();

            svg.selectAll(".country")
              .data(countriesWithData)
              .enter()
              .append("path")
              .attr("class", "country")
              .attr("d", path)
              .attr("fill", d => {
                let val = alcoholData[d.properties.name][selectedDrink];
                return colorScale(val);
              })
              .attr("stroke", "#333")  // Bordes de los países
              .attr("stroke-width", 0.5)  // Grosor del borde
              .on("mouseover", function(event, d) {
                let name = d.properties.name;
                let consumption = alcoholData[name][selectedDrink];
                let total = alcoholData[name].total_alcohol;

                // Cambiar el color de relleno cuando se pasa el ratón por encima
                d3.select(this).attr("fill", "#800026");

                tooltip.transition().duration(200).style("opacity", 1);
                tooltip.html(`${name}<br>${selectedDrink.charAt(0).toUpperCase() + selectedDrink.slice(1)}: ${consumption}<br>Total Alcohol: ${total}`)
                  .style("left", (event.pageX + 5) + "px")
                  .style("top", (event.pageY - 28) + "px");
              })
              .on("mouseout", function(event, d) {
                let name = d.properties.name;
                let val = alcoholData[name][selectedDrink];
                d3.select(this).attr("fill", colorScale(val)); // Volver al color original

                tooltip.transition().duration(500).style("opacity", 0);
              });

            // Añadir etiquetas a países grandes y relevantes
            svg.selectAll(".country-label")
              .data(countriesWithData.filter(d => bigCountries.includes(d.properties.name)))
              .enter()
              .append("text")
              .attr("class", "country-label")
              .attr("transform", d => {
                let coords = path.centroid(d);
                return coords ? `translate(${coords})` : null;
              })
              .attr("text-anchor", "middle")
              .attr("dy", ".35em")
              .text(d => d.properties.name)
              .style("pointer-events", "none");

            // Actualizar la leyenda según la bebida seleccionada
            updateLegend(selectedDrink);
          }

          updateMap("beer");

          d3.select("#drink-selector").on("change", function() {
            currentDrink = this.value;
            updateMap(currentDrink);
          });
        });
      });

      // Actualizar el tamaño del mapa cuando cambie el tamaño de la ventana
      window.addEventListener("resize", updateMapSize);
    </script>
</body>
</html>
